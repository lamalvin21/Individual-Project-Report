\chapter{Design}
This design chapter provides a high-level overview of the software implementation. With the aid of visual tools such as diagrams, a plan for implementation will be outlined. 

\section{UML Sequence Diagram}
\hspace{0.5cm} A high-level overview from user input to output is important to illustrate so it may be followed in later sections of this chapter. Providing a visual representation also makes it easier to understand how all  relevant components of the project interact. Most SPARQL Anything calls follow the same format as depicted in \textit{Figure 4} of \cite{asprino2023knowledge} and is strictly followed in \textit{Figure 7.1}. A contextualised UML Sequence diagram is shown in \textit{Figure 7.1}: 

\begin{figure}
\begin{center}
    \includegraphics[width=8cm, height=6cm]{Images/UMLSequenceDiagram.drawio.png}
\end{center}
\vspace{-0.4cm}
\caption{UML Sequence Diagram}
\end{figure}

\section{Ontology Structure}
\hspace{0.5cm} In this section, the plan for the ontology's general structure will be outlined based on the dataset, provided ontology and any external websites. 

\begin{figure}[H]
    \begin{center}
        \begin{tikzpicture} [
            circle/.style={draw=blue, ellipse, ultra thick, fill=blue!30},
            align=center,
            node distance=2.5cm ]
            
        \node[circle] (q0) {Organ};
        \node[circle, right of=q0] (q1)  {Technical};
        \node[circle, left of=q0] (q2)  {Changes};
        \node[circle, above of=q0] (q3)  {Disposition};
        \node[circle, below of=q0] (q4)  {OrganWikidata};
    
        \draw[] (q0.east) -- (q1.west);
        \draw[] (q0.west) -- (q2.east);
        \draw[] (q0.north) -- (q3.south);
        \draw[] (q0.south) -- (q4.north);
            
        \end{tikzpicture}
    \end{center}
    \vspace{-0.4cm}
\caption{Core Organ Ontology}
\end{figure}
\vspace{-0.1cm}

\textit{Figure 7.2} illustrates the main components to be expanded on in the ontology based on the data in the dataset. More details of the main nodes are detailed below:

\begin{enumerate}
    \item \textbf{Organ}: The primary organ component that will connect to other many other nodes.
    \item \textbf{Changes}: This component specifies the organ adjustment details and maintenance changes in the organ.
    \item \textbf{Disposition}: This component refers to the organ's current components and details relating to them.
    \item \textbf{Technicals:} This component was responsible for the specific musical details of the organ. 
    \item \textbf{OrganWikidata}: This provides expansion of the existing knowledge graph from Wikidata.
\end{enumerate}

The section of the ontology specifically for external Wikidata links can be structured in the same format as displayed on its website. From the diagram above, extending the \textit{OrganWikidata} node is most plausible.

For example, the organ page on Wikidata \cite{organwikidata} contains organ-related triples. An extract of \cite{organwikidata} is shown below:

\lstset
{
    breaklines=true,
    breakatwhitespace=true,
    basicstyle=\ttfamily,
}
\begin{lstlisting}

organ subclassOf keyboardInstrument
organ subclassOf buildingComponent
organ studiedBy organology 
...

\end{lstlisting}
(from \cite{organwikidata})

In this case, 'organ' can be replaced with our \textit{OrganWikidata} node and the corresponding relationships and objects can be added to the ontology. All the extra nodes and edges can be added as external links to the knowledge graph using their unique Wikidata URI. 

\section{Query Flow Diagram}
\hspace{0.5cm} A flow diagram is a graphical representation of the sequence of steps or actions that need to be taken to complete a process. \cite{flowchart}

In this section, the logic required to build the SPARQL Anything Query will be illustrated in the form of a flow diagram. This will provide the structure required to build the query and produce a knowledge graph.

\begin{figure}[H]
    \begin{center}
        \begin{tikzpicture} [
            circle/.style={draw=green, ellipse, ultra thick, fill=green!30},
            align=center,
            node distance=2.5cm ]
        \node[circle] (q0) {Add ontology};
        \node[circle, below of=q0] (q1)  {Query dataset};
        \node[circle, below of=q1] (q2)  {Clean \& Refine data};
        \node[circle, below of=q2] (q3)  {Get external links};
        \node[circle, below of=q3] (q4)  {String manipulation with external links};
        \node[circle, below of=q4] (q5)  {Add to Knowledge graph};
        \node[circle, below of=q5] (q6)  {Add any other external links};
        \node[circle, below of=q6] (q7)  {Output Knowledge Graph};
    
        \draw[->] (q0.south) -- (q1.north);
        \draw[->] (q1.south) -- (q2.north);
        \draw[->] (q2.south) -- (q3.north) node [midway, fill=white] {Using cleaned data};
        \draw[->] (q3.south) -- (q4.north);
        \draw[->] (q4.south) -- (q5.north);
        \draw[->] (q5.south) -- (q6.north);
        \draw[->] (q6.south) -- (q7.north);
        \draw[->] (q2.east) to [out=0,in=0] (q5.east);
        \draw[->] (q5.west) to [out=180,in=180] (q2.west);
    
        \end{tikzpicture}
    \end{center}
    \vspace{-0.4cm}
    \caption{Query Flow Diagram}
\end{figure}
\vspace{-0.1cm}

The nodes in \textit{Figure 7.3} represent necessary actions and one of the edges is explicitly stated so that the process is clear. Below, an explanation for each node is provided: 

\begin{enumerate}
  \item \textbf{'Add ontology' node} refers to the addition of the ontology to the query.
  \item \textbf{'Query dataset' node} uses SPARQL Anything to search for and find relevant data within the dataset.
  \item \textbf{'Clean \& Refine data' node} Refines data to be put into the knowledge graph or to be used as external links. Involves two pathways to account for the data with no external links.
  \item \textbf{'Get external links' node} uses the clean and refined data above to find other links, but only if requested.
  \item \textbf{'String manipulation with external links' node} configures links in a readable or useful format (URI) to be put into the knowledge graph.
  \item \textbf{'Add to knowledge graph' node} adds either clean and refined data from node 3 as well as external links to the knowledge graph. Once a specific file from the dataset has been queried, it loops again on a different file until all files have been queried.
  \item \textbf{'Add any other external links' node} adds any other links that do not require data from the dataset.
  \item \textbf{'Output knowledge graph' node} produces the result.
\end{enumerate}

\section{Query Skeleton Structure}
\hspace{0.5cm} In this section, the flow diagram, illustrated in the previous section, will be used to structure the query.

\lstset
{
    breaklines=true,
    breakatwhitespace=true,
    basicstyle=\ttfamily,
}
\begin{lstlisting}
PREFIX ... # Add relevant links

CONSTRUCT {
    ... # Add organ ontology
} 
WHERE 
    { 
        SERVICE <x-sparql-anything:file:./___.json>  # Query dataset
        { 
            ... # Clean and refine data
            ... # Get external links (if any)
            ... # String manipulation with external links (if applicable)
            ... # Add to knowledge graph
        } 
        SERVICE <x-sparql-anything:file:./___`.json>  # Query dataset
        { 
            ... # Clean and refine data
            ... # Get external links (if any)
            ... # String manipulation with external links (if applicable)
            ... # Add to knowledge graph
        } 
        .
        .
        .
        ... # Add any other external links 
        # Output knowledge graph
    }

\end{lstlisting}

This basic query structure follows all steps in the flow graph above and aids query creation to generate a knowledge graph. This can be observed in the comments next to each line, which correspond to a step in the flow diagram created. It also outlines the basic structure that will be used to create the query. The multiple SERVICE calls refer to the multiple .JSON files in the dataset being queried. 

